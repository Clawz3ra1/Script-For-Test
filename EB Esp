-- ESP com UI arredondada e arrastável

local toggleButton = script.Parent:WaitForChild("ToggleESPButton")
local espEnabled = true

-- Color presets
local onColor = Color3.fromRGB(0, 255, 127)
local offColor = Color3.fromRGB(255, 85, 85)

-- Setup botão
toggleButton.BackgroundColor3 = onColor
toggleButton.Text = "Desativar ESP"

-- Referência ao LocalPlayer
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local camera = workspace.CurrentCamera
local localPlayer = Players.LocalPlayer

-- Tabela de ESPs
local ESPs = {}

-- Toggle global (usado no RenderStepped)
_G.ESP_Enabled = true

-- Criar ESP
local function createESP(player)
	if player == localPlayer or ESPs[player] then return end

	local box = Drawing.new("Square")
	box.Visible = false
	box.Color = Color3.fromRGB(0, 255, 0)
	box.Thickness = 2
	box.Transparency = 1
	box.Filled = false

	local nameText = Drawing.new("Text")
	nameText.Visible = false
	nameText.Color = Color3.fromRGB(255, 255, 255)
	nameText.Size = 16
	nameText.Center = true
	nameText.Outline = true
	nameText.Font = 2

	local tracer = Drawing.new("Line")
	tracer.Visible = false
	tracer.Color = Color3.fromRGB(0, 255, 0)
	tracer.Thickness = 1
	tracer.Transparency = 1

	ESPs[player] = {
		Box = box,
		Name = nameText,
		Tracer = tracer,
	}

	player.CharacterAdded:Connect(function()
		wait(1)
		createESP(player)
	end)
end

-- Remover ESP
local function removeESP(player)
	if ESPs[player] then
		for _, drawing in pairs(ESPs[player]) do
			drawing:Remove()
		end
		ESPs[player] = nil
	end
end

-- Atualização dos ESPs
RunService.RenderStepped:Connect(function()
	for player, esp in pairs(ESPs) do
		local character = player.Character
		local hrp = character and character:FindFirstChild("HumanoidRootPart")
		local head = character and character:FindFirstChild("Head")
		local humanoid = character and character:FindFirstChild("Humanoid")

		if hrp and head and humanoid and humanoid.Health > 0 and _G.ESP_Enabled then
			local pos, onScreen = camera:WorldToViewportPoint(hrp.Position)
			local headPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
			local size = (camera:WorldToViewportPoint(hrp.Position - Vector3.new(2, 3, 0)) - camera:WorldToViewportPoint(hrp.Position + Vector3.new(2, 3, 0))).Magnitude

			if onScreen then
				esp.Box.Visible = true
				esp.Box.Size = Vector2.new(size, size * 2)
				esp.Box.Position = Vector2.new(pos.X - size / 2, pos.Y - size)
				esp.Name.Visible = true
				esp.Name.Text = player.Name
				esp.Name.Position = Vector2.new(headPos.X, headPos.Y - 15)
				esp.Tracer.Visible = true
				esp.Tracer.From = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y)
				esp.Tracer.To = Vector2.new(pos.X, pos.Y)
			else
				esp.Box.Visible = false
				esp.Name.Visible = false
				esp.Tracer.Visible = false
			end
		else
			esp.Box.Visible = false
			esp.Name.Visible = false
			esp.Tracer.Visible = false
		end
	end
end)

-- Criar ESPs existentes
for _, player in pairs(Players:GetPlayers()) do
	createESP(player)
end
Players.PlayerAdded:Connect(createESP)
Players.PlayerRemoving:Connect(removeESP)

-- Toggle do botão
toggleButton.MouseButton1Click:Connect(function()
	_G.ESP_Enabled = not _G.ESP_Enabled
	if _G.ESP_Enabled then
		toggleButton.Text = "Desativar ESP"
		toggleButton.BackgroundColor3 = onColor
	else
		toggleButton.Text = "Ativar ESP"
		toggleButton.BackgroundColor3 = offColor
	end
end)
